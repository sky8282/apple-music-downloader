# ä¸‹è½½é€»è¾‘é—®é¢˜è¯¦ç»†åˆ†æ

## ğŸ“Š å½“å‰å®ç° vs æœŸæœ›é€»è¾‘å¯¹æ¯”

### âœ… å·²æ­£ç¡®å®ç°çš„éƒ¨åˆ†

1. **å•æ›²å»é‡** (downloadTrackSilently, ç¬¬413-436è¡Œ)
   - âœ… ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œæ£€æŸ¥æœ€ç»ˆç›®æ ‡è·¯å¾„
   - âœ… æ–‡ä»¶å·²å­˜åœ¨åˆ™è·³è¿‡ä¸‹è½½
   - âœ… è¿”å›å·²å­˜åœ¨æ–‡ä»¶çš„è·¯å¾„

2. **ä¸“è¾‘å»é‡** (Rip, ç¬¬776-853è¡Œ)
   - âœ… æ£€æŸ¥æ‰€æœ‰é€‰ä¸­æ›²ç›®
   - âœ… å…¨éƒ¨å­˜åœ¨æ—¶è·³è¿‡æ•´ä¸ªä¸“è¾‘
   - âœ… é¿å…è¿›å…¥ä¸‹è½½å¾ªç¯

3. **ä¸‹è½½åˆ°ç¼“å­˜** (ç¬¬438-455è¡Œ)
   - âœ… æ–°æ–‡ä»¶ä¸‹è½½åˆ°ç¼“å­˜è·¯å¾„
   - âœ… åœ¨ç¼“å­˜å®ŒæˆåŠ å·¥ï¼ˆFFmpegã€æ ‡ç­¾ï¼‰

4. **æ‰¹æ¬¡è½¬ç§»** (ç¬¬1078-1131è¡Œ)
   - âœ… æ‰¹æ¬¡å®Œæˆåè½¬ç§»æ–‡ä»¶
   - âœ… é¿å…ç¼“å­˜å †ç§¯

5. **æ¸…ç†ç¼“å­˜** (ç¬¬1200-1203è¡Œ)
   - âœ… è½¬ç§»å®Œæˆåæ¸…ç†ç¼“å­˜

## âŒ å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜1ï¼šSafeMoveFile ä¼šè¦†ç›–å·²å­˜åœ¨æ–‡ä»¶

**ä½ç½®**ï¼š`internal/utils/helpers.go` ç¬¬168-224è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```go
func SafeMoveFile(src, dst string) error {
    // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    dstDir := filepath.Dir(dst)
    if err := os.MkdirAll(dstDir, os.ModePerm); err != nil {
        return fmt.Errorf("åˆ›å»ºç›®æ ‡ç›®å½•å¤±è´¥: %w", err)
    }

    // é¦–å…ˆå°è¯•ç›´æ¥é‡å‘½åï¼ˆæœ€å¿«çš„æ–¹å¼ï¼‰
    if err := os.Rename(src, dst); err == nil {
        return nil  // â† é—®é¢˜ï¼šå¦‚æœdstå·²å­˜åœ¨ï¼Œos.Renameä¼šè¦†ç›–ï¼
    }

    // å¦‚æœé‡å‘½åå¤±è´¥ï¼Œä½¿ç”¨æ‹·è´+åˆ é™¤
    // ... æ‹·è´é€»è¾‘ ...
    // â† é—®é¢˜ï¼šè¿™é‡Œä¹Ÿä¼šè¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
}
```

**å½±å“**ï¼š
- å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šè¢«è¦†ç›–
- è™½ç„¶ä¸‹è½½é€»è¾‘å·²ç»è·³è¿‡äº†å·²å­˜åœ¨çš„æ–‡ä»¶
- ä½†å¦‚æœç¼“å­˜ä¸­æœ‰æ®‹ç•™æ–‡ä»¶ï¼Œè½¬ç§»æ—¶ä¼šè¦†ç›–ç›®æ ‡

### é—®é¢˜2ï¼šç¼“å­˜è½¬ç§»æ—¶æœªåšæ–‡ä»¶å­˜åœ¨æ£€æŸ¥

**ä½ç½®**ï¼šç¬¬1183è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```go
// è½¬ç§»æ–‡ä»¶
if err := utils.SafeMoveFile(cachePath, targetPath); err != nil {
    fmt.Printf("è­¦å‘Š: è½¬ç§»æ–‡ä»¶å¤±è´¥ %s: %v\n", relPath, err)
}
```

**åº”è¯¥æ˜¯**ï¼š
```go
// æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
exists, _ := utils.FileExists(targetPath)
if exists {
    // è·³è¿‡ï¼Œä¸è¦†ç›–
    continue
}

// è½¬ç§»æ–‡ä»¶
if err := utils.SafeMoveFile(cachePath, targetPath); err != nil {
    fmt.Printf("è­¦å‘Š: è½¬ç§»æ–‡ä»¶å¤±è´¥ %s: %v\n", relPath, err)
}
```

### é—®é¢˜3ï¼šæ²¡æœ‰çœŸæ­£çš„"å¢é‡ä¸‹è½½"æ”¯æŒ

**æœŸæœ›è¡Œä¸º**ï¼š
```
ä¸“è¾‘æœ‰10é¦–ï¼Œæœ¬åœ°å·²æœ‰5é¦–
â†’ åªä¸‹è½½å¦å¤–5é¦–
â†’ åªè½¬ç§»æ–°ä¸‹è½½çš„5é¦–
â†’ ä¸å½±å“å·²æœ‰çš„5é¦–
```

**å½“å‰è¡Œä¸º**ï¼š
```
ä¸“è¾‘æœ‰10é¦–ï¼Œæœ¬åœ°å·²æœ‰5é¦–
â†’ æ£€æŸ¥åˆ°ä¸æ˜¯å…¨éƒ¨å­˜åœ¨ï¼ˆallFilesExist=falseï¼‰
â†’ è¿›å…¥ä¸‹è½½å¾ªç¯
â†’ å·²å­˜åœ¨çš„5é¦–è¢«è·³è¿‡ï¼ˆdownloadTrackSilentlyæ£€æŸ¥ï¼‰âœ…
â†’ ä¸‹è½½æ–°çš„5é¦–åˆ°ç¼“å­˜ âœ…
â†’ è½¬ç§»æ—¶ï¼š
   - å¦‚æœç¼“å­˜åªæœ‰æ–°çš„5é¦–ï¼šæ­£å¸¸ âœ…
   - å¦‚æœç¼“å­˜æœ‰æ®‹ç•™ï¼ˆæ—§çš„10é¦–ï¼‰ï¼šå¯èƒ½è¦†ç›–ç›®æ ‡ âŒ
```

**æ ¹æœ¬é—®é¢˜**ï¼š
- è½¬ç§»é€»è¾‘æ˜¯"ç›²ç›®è½¬ç§»ç¼“å­˜ä¸­æ‰€æœ‰æ–‡ä»¶"
- æ²¡æœ‰æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
- ä¾èµ–"ç¼“å­˜åªæœ‰æ–°æ–‡ä»¶"çš„å‡è®¾ï¼ˆä¸å¯é ï¼‰

## ğŸ”§ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šSafeMoveFile æ·»åŠ å­˜åœ¨æ£€æŸ¥é€‰é¡¹

```go
// SafeMoveFile æ·»åŠ å‚æ•°æ§åˆ¶æ˜¯å¦è¦†ç›–
func SafeMoveFile(src, dst string, overwrite bool) error {
    // æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if !overwrite {
        exists, _ := FileExists(dst)
        if exists {
            return fmt.Errorf("ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡")
        }
    }
    
    // ... åŸæœ‰é€»è¾‘ ...
}
```

### ä¿®å¤2ï¼šè½¬ç§»é€»è¾‘æ·»åŠ å­˜åœ¨æ£€æŸ¥

```go
// è½¬ç§»æ–‡ä»¶
if info.IsDir() {
    return os.MkdirAll(targetPath, info.Mode())
}

// âœ… æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
targetExists, _ := utils.FileExists(targetPath)
if targetExists {
    // è·³è¿‡ï¼Œä¸è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
    return nil
}

// è½¬ç§»æ–‡ä»¶
if err := utils.SafeMoveFile(cachePath, targetPath, false); err != nil {
    fmt.Printf("è­¦å‘Š: è½¬ç§»æ–‡ä»¶å¤±è´¥ %s: %v\n", relPath, err)
}
```

### ä¿®å¤3ï¼šæ‰¹æ¬¡è½¬ç§»ä¹Ÿæ·»åŠ æ£€æŸ¥

```go
// æ‰¹æ¬¡è½¬ç§»ï¼ˆç¬¬1078-1131è¡Œï¼‰
if info.IsDir() {
    os.MkdirAll(targetPath, info.Mode())
} else if strings.HasSuffix(cachePath, ".m4a") || strings.HasSuffix(cachePath, ".jpg") {
    // âœ… æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    targetExists, _ := utils.FileExists(targetPath)
    if !targetExists {
        if err := utils.SafeMoveFile(cachePath, targetPath, false); err == nil {
            moveCount++
        }
    }
}
```

## ğŸ“ å®Œæ•´çš„ä¿®å¤æµç¨‹

### Step 1: ä¿®æ”¹ SafeMoveFile å‡½æ•°

```go
func SafeMoveFile(src, dst string) error {
    // 1. æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    targetExists, _ := FileExists(dst)
    if targetExists {
        // è·³è¿‡ï¼Œè¿”å›ç‰¹æ®Šé”™è¯¯
        return fmt.Errorf("ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨")
    }
    
    // 2. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    dstDir := filepath.Dir(dst)
    if err := os.MkdirAll(dstDir, os.ModePerm); err != nil {
        return fmt.Errorf("åˆ›å»ºç›®æ ‡ç›®å½•å¤±è´¥: %w", err)
    }

    // 3. åŸæœ‰çš„ç§»åŠ¨é€»è¾‘...
}
```

### Step 2: ä¿®æ”¹è½¬ç§»é€»è¾‘ï¼ˆæœ€ç»ˆè½¬ç§»ï¼‰

```go
// é€’å½’è½¬ç§»æ‰€æœ‰å­ç›®å½•
moveErr := filepath.Walk(cacheHashDir, func(cachePath string, info os.FileInfo, walkErr error) error {
    // ... è·³è¿‡æ ¹ç›®å½•ã€è®¡ç®—è·¯å¾„ ...
    
    if info.IsDir() {
        return os.MkdirAll(targetPath, info.Mode())
    }
    
    // âœ… æ·»åŠ ï¼šæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    targetExists, _ := utils.FileExists(targetPath)
    if targetExists {
        // è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œä¸è¦†ç›–
        return nil
    }
    
    // è½¬ç§»æ–‡ä»¶
    if err := utils.SafeMoveFile(cachePath, targetPath); err != nil {
        if !strings.Contains(err.Error(), "ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨") {
            fmt.Printf("è­¦å‘Š: è½¬ç§»æ–‡ä»¶å¤±è´¥ %s: %v\n", relPath, err)
        }
    }
    return nil
})
```

### Step 3: ä¿®æ”¹æ‰¹æ¬¡è½¬ç§»é€»è¾‘

```go
// é€’å½’è½¬ç§»æ‰€æœ‰æ–‡ä»¶
moveCount := 0
filepath.Walk(cacheHashDir, func(cachePath string, info os.FileInfo, walkErr error) error {
    // ... è·¯å¾„å¤„ç† ...
    
    if info.IsDir() {
        os.MkdirAll(targetPath, info.Mode())
    } else if strings.HasSuffix(cachePath, ".m4a") || strings.HasSuffix(cachePath, ".jpg") {
        // âœ… æ·»åŠ ï¼šæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
        targetExists, _ := utils.FileExists(targetPath)
        if !targetExists {
            if err := utils.SafeMoveFile(cachePath, targetPath); err == nil {
                moveCount++
            }
        }
    }
    return nil
})
```

## ğŸ¯ ä¿®å¤åçš„å®Œæ•´æµç¨‹

### æ— å·®å¼‚æƒ…å†µï¼ˆæ‰€æœ‰æ–‡ä»¶éƒ½å·²å­˜åœ¨ï¼‰
```
1. è¯»å–ä¸“è¾‘æ•°æ®
2. æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ï¼ˆç¬¬776-834è¡Œï¼‰â†’ allFilesExist = true
3. è·³è¿‡ä¸‹è½½ï¼ˆç¬¬836-853è¡Œï¼‰â†’ return
4. âœ… ä¸è¿›å…¥ä¸‹è½½å¾ªç¯
5. âœ… ä¸è½¬ç§»ä»»ä½•æ–‡ä»¶
6. âœ… ä¸è¦†ç›–ä»»ä½•æ–‡ä»¶
```

### æœ‰å·®å¼‚æƒ…å†µï¼ˆéƒ¨åˆ†æ–‡ä»¶å·²å­˜åœ¨ï¼‰
```
1. è¯»å–ä¸“è¾‘æ•°æ®
2. æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ â†’ allFilesExist = false
3. è¿›å…¥ä¸‹è½½å¾ªç¯
   - å¯¹äºå·²å­˜åœ¨çš„æ–‡ä»¶ï¼š
     a. downloadTrackSilently æ£€æŸ¥ï¼ˆç¬¬429-436è¡Œï¼‰â†’ exists = true
     b. è·³è¿‡ä¸‹è½½ â†’ return returnPath
     c. âœ… ä¸ä¸‹è½½åˆ°ç¼“å­˜
   - å¯¹äºä¸å­˜åœ¨çš„æ–‡ä»¶ï¼š
     a. downloadTrackSilently æ£€æŸ¥ â†’ exists = false
     b. ä¸‹è½½åˆ°ç¼“å­˜ï¼ˆç¬¬438-455è¡Œï¼‰
     c. åœ¨ç¼“å­˜å®ŒæˆåŠ å·¥ï¼ˆFFmpegã€æ ‡ç­¾ï¼‰
4. æ‰¹æ¬¡è½¬ç§»/æœ€ç»ˆè½¬ç§»ï¼š
   a. æ‰«æç¼“å­˜ä¸­çš„æ–‡ä»¶
   b. âœ… æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
   c. âœ… å·²å­˜åœ¨çš„è·³è¿‡ï¼Œä¸è¦†ç›–
   d. âœ… åªè½¬ç§»æ–°æ–‡ä»¶
5. æ¸…ç†ç¼“å­˜
```

## âš ï¸ é£é™©åˆ†æ

### å½“å‰é£é™©
- **é«˜é£é™©**ï¼šç¼“å­˜ä¸­çš„æ®‹ç•™æ–‡ä»¶å¯èƒ½è¦†ç›–ç›®æ ‡æ–‡ä»¶
- **ä¸­é£é™©**ï¼šSafeMoveFile é»˜è®¤è¦†ç›–è¡Œä¸º
- **ä½é£é™©**ï¼šç†è®ºä¸Šç¼“å­˜åº”è¯¥æ˜¯å¹²å‡€çš„ï¼ˆå› ä¸ºæ¯æ¬¡éƒ½æ¸…ç†ï¼‰

### ä¿®å¤åé£é™©
- **æ— é£é™©**ï¼šæ˜ç¡®æ£€æŸ¥ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§
- **æ— é£é™©**ï¼šå³ä½¿ç¼“å­˜æœ‰æ®‹ç•™ï¼Œä¹Ÿä¸ä¼šè¦†ç›–
- **æ— é£é™©**ï¼šçœŸæ­£çš„å¢é‡ä¸‹è½½å’Œè½¬ç§»

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

1. **P0ï¼ˆç«‹å³ä¿®å¤ï¼‰**ï¼šSafeMoveFile æ·»åŠ å­˜åœ¨æ£€æŸ¥
2. **P0ï¼ˆç«‹å³ä¿®å¤ï¼‰**ï¼šè½¬ç§»é€»è¾‘æ·»åŠ å­˜åœ¨æ£€æŸ¥
3. **P1ï¼ˆå»ºè®®ä¿®å¤ï¼‰**ï¼šæ‰¹æ¬¡è½¬ç§»æ·»åŠ å­˜åœ¨æ£€æŸ¥
4. **P2ï¼ˆä¼˜åŒ–ï¼‰**ï¼šæ·»åŠ æ—¥å¿—ï¼Œè®°å½•è·³è¿‡çš„æ–‡ä»¶

---

**ç»“è®º**ï¼šå½“å‰é€»è¾‘**åŸºæœ¬æ­£ç¡®**ï¼Œä½†ç¼ºå°‘å…³é”®çš„**æ–‡ä»¶å­˜åœ¨æ£€æŸ¥**ï¼Œå¯èƒ½å¯¼è‡´**æ„å¤–è¦†ç›–**ã€‚å»ºè®®ç«‹å³ä¿®å¤ã€‚

